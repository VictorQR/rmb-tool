<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汇率换算工具</title>
    <style>
        :root {
            --primary-color: #007aff;
            --bg-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.15);
            --text-color: #333;
            --border-color: #ddd;
            --input-bg: #fff;
            --header-border: #eee;
            --footer-color: #555;
            --default-gradient-start: #e0f7fa;
            --default-gradient-end: #c5e4f7;
        }

        /* Dark mode variables */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #2c2c2c;
                --shadow-color: rgba(0, 0, 0, 0.4);
                --text-color: #e0e0e0;
                --border-color: #444;
                --input-bg: #3c3c3c;
                --header-border: #444;
                --footer-color: #bbb;
                --default-gradient-start: #1c2a39;
                --default-gradient-end: #2a3d4e;
            }
        }

        /* Force dark mode */
        body.dark-mode {
            --bg-color: #2c2c2c;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --text-color: #e0e0e0;
            --border-color: #444;
            --input-bg: #3c3c3c;
            --header-border: #444;
            --footer-color: #bbb;
            --default-gradient-start: #1c2a39;
            --default-gradient-end: #2a3d4e;
        }

        /* Force light mode */
        body.light-mode {
            --bg-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.15);
            --text-color: #333;
            --border-color: #ddd;
            --input-bg: #fff;
            --header-border: #eee;
            --footer-color: #555;
            --default-gradient-start: #e0f7fa;
            --default-gradient-end: #c5e4f7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            color: var(--text-color);
            overflow-x: hidden;
            background: linear-gradient(135deg, var(--default-gradient-start) 0%, var(--default-gradient-end) 100%);
            background-attachment: fixed;
            transition: background 0.5s ease, color 0.5s ease;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            min-height: 100vh;
        }
        .converter-wrapper {
            background: var(--bg-color);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px var(--shadow-color);
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--header-border);
            padding-bottom: 1rem;
        }
        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.6rem;
        }
        #settings-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            color: var(--text-color);
        }
        #settings-btn:hover { background-color: rgba(0,0,0,0.05); }
        body.dark-mode #settings-btn:hover, body.light-mode #settings-btn:hover {
             background-color: var(--input-bg);
        }

        #currency-grid { display: grid; gap: 1.5rem; }
        .currency-card {
            display: grid;
            grid-template-columns: 50px 1fr;
            align-items: center;
            gap: 1rem;
        }
        .currency-label { font-size: 1.2rem; font-weight: 600; }
        .currency-input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: right;
            background-color: var(--input-bg);
            color: var(--text-color);
            box-sizing: border-box;
            -moz-appearance: textfield;
            transition: box-shadow 0.2s, border-color 0.2s, background-color 0.2s, color 0.2s;
        }
        .currency-input:disabled { background-color: #f0f2f5; cursor: not-allowed; }
        body.dark-mode .currency-input:disabled { background-color: #333; }
        .currency-input::-webkit-outer-spin-button, .currency-input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .currency-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        .rmb-capital-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .rmb-capital-section label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }
        .capital-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #capital-result {
            flex-grow: 1;
            padding: 0.8rem;
            background-color: var(--input-bg);
            border-radius: 8px;
            min-height: 20px;
            word-wrap: break-word;
            font-weight: 500;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        #copy-capital {
            padding: 0.8rem 1rem;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        #copy-capital:hover {
            background-color: #0056b3;
        }
        .rate-info {
            font-size: 0.8rem;
            color: var(--footer-color);
            text-align: center;
            margin-top: 1.5rem;
            min-height: 1.2em;
        }
        footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--footer-color);
            text-shadow: none;
            line-height: 1.5;
        }
        footer a { color: var(--primary-color); font-weight: 600; text-decoration: none;}
        footer a:hover { text-decoration: underline; }
        
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #settings-modal.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-color); padding: 2rem; border-radius: 16px;
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            color: var(--text-color);
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .modal-header h2 { margin: 0; }
        #close-modal {
            background:none; border:none; font-size: 1.8rem; cursor:pointer;
            color: var(--text-color);
            line-height: 1;
        }
        .modal-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .modal-section:first-of-type {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        .modal-footer { margin-top: 2rem; text-align: right; }
        #save-settings {
            background-color: var(--primary-color); color: #fff; border: none;
            padding: 0.8rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        #save-settings:hover { background-color: #0056b3; }

        .color-picker-controls, .preset-gradient-controls, .theme-mode-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .color-picker-controls label, .preset-gradient-controls label, .theme-mode-controls label {
            font-weight: 600;
            margin-bottom: 0;
        }
        #bg-color-picker {
            width: 50px;
            height: 38px;
            border: 1px solid var(--border-color);
            padding: 0;
            border-radius: 8px;
            cursor: pointer;
            background: var(--input-bg);
        }
        #apply-color-btn, #set-default-gradient-btn {
            padding: 0.6rem 1rem;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #apply-color-btn:hover { background-color: #218838; }
        #set-default-gradient-btn { background-color: #6c757d; }
        #set-default-gradient-btn:hover { background-color: #5a6268; }

        #preset-gradient-select {
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            flex-grow: 1;
        }

        .theme-mode-controls button {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .theme-mode-controls button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .theme-mode-controls button:hover:not(.active) {
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .theme-mode-controls button:hover:not(.active) {
             background-color: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="converter-wrapper">
            <header>
                <h1>汇率换算工具</h1>
                <button id="settings-btn" title="设置常用货币和主题">⚙️</button>
            </header>
            <div id="currency-grid"></div>
            <div class="rmb-capital-section">
                <label for="capital-result">人民币大写</label>
                <div class="capital-container">
                    <div id="capital-result"></div>
                    <button id="copy-capital">复制</button>
                </div>
            </div>
            <div id="rate-info" class="rate-info">正在初始化...</div>
        </div>
        <footer>
            <div>
                汇率数据来源：<a href="https://www.exchangerate-api.com" target="_blank">ExchangeRate-API</a>
            </div>
            <div>
                项目由 <a href="https://github.com/VictorQR" target="_blank">VictorQR</a> 开发
                <a href="https://github.com/VictorQR/rmb-tool/" target="_blank">(GitHub 项目)</a>
            </div>
        </footer>
    </div>
    
    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>自定义设置</h2>
                <button id="close-modal" aria-label="关闭">&times;</button>
            </div>
            
            <section class="modal-section currency-settings">
                <h3>常用货币</h3>
                <p>请选择您想在主页显示的货币（建议3-6种）。</p>
                <div id="currency-options"></div>
            </section>

            <section class="modal-section theme-settings">
                <h3>主题模式</h3>
                <div class="theme-mode-controls">
                    <button id="system-theme-btn">跟随系统</button>
                    <button id="light-theme-btn">亮色模式</button>
                    <button id="dark-theme-btn">暗色模式</button>
                </div>
            </section>

            <section class="modal-section color-picker-section">
                <h3>自定义背景</h3>
                <p>选择一个基色来生成渐变背景。</p>
                <div class="color-picker-controls">
                    <input type="color" id="bg-color-picker">
                    <button id="apply-color-btn">应用自定义色</button>
                </div>
            </section>

            <section class="modal-section preset-gradient-section">
                <h3>预设渐变背景</h3>
                <p>从预设列表中选择您喜欢的背景。</p>
                <div class="preset-gradient-controls">
                    <select id="preset-gradient-select">
                        <option value="">选择一个预设...</option>
                    </select>
                    <button id="set-default-gradient-btn">应用预设</button>
                </div>
            </section>
            
            <div class="modal-footer">
                <button id="save-settings">保存设置</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '87a8d7f1b40d9dbcd30a96a2'; // 请替换为你的 ExchangeRate-API Key
        const ALL_CURRENCIES = {
            'CNY': '人民币', 'USD': '美元', 'EUR': '欧元', 'JPY': '日元', 'HKD': '港币',
            'GBP': '英镑', 'AUD': '澳元', 'CAD': '加元', 'SGD': '新加坡元', 'CHF': '瑞士法郎',
            'TWD': '新台币', 'KRW': '韩元', 'THB': '泰铢', 'MOP': '澳门元', 'MYR': '马来西亚林吉特'
        };

        const PRESET_GRADIENTS = [
            { name: "蓝色海洋", start: "#a1c4fd", end: "#c2e9fb", darkStart: "#0f2027", darkEnd: "#2c5364" },
            { name: "绿色森林", start: "#d4fc79", end: "#96e6a1", darkStart: "#0a4e32", darkEnd: "#236b4b" },
            { name: "紫色黄昏", start: "#a7a6cb", end: "#8989ba", darkStart: "#302b63", darkEnd: "#24243e" },
            { name: "橙色暖阳", start: "#fbc2eb", end: "#a6c1ee", darkStart: "#4b1e3c", darkEnd: "#6b3b5b" },
            { name: "灰色极简", start: "#e0e0e0", end: "#b3b3b3", darkStart: "#303030", darkEnd: "#505050" },
            { name: "活力粉橙", start: "#fdfbfb", end: "#ebedee", darkStart: "#1a1a2e", darkEnd: "#16213e" },
            { name: "默认渐变", start: "#e0f7fa", end: "#c5e4f7", darkStart: "#1c2a39", darkEnd: "#2a3d4e" } // Keep default at the end
        ];

        let rates = {};
        let activeCurrencies = [];
        let currentThemeMode = 'system'; // 'system', 'light', 'dark'
        let currentGradient = {
            start: getComputedStyle(document.documentElement).getPropertyValue('--default-gradient-start').trim(),
            end: getComputedStyle(document.documentElement).getPropertyValue('--default-gradient-end').trim()
        };


        const currencyGrid = document.getElementById('currency-grid');
        const capitalResult = document.getElementById('capital-result');
        const rateInfo = document.getElementById('rate-info');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const saveSettingsBtn = document.getElementById('save-settings');
        const currencyOptionsContainer = document.getElementById('currency-options');
        const copyCapitalBtn = document.getElementById('copy-capital');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const applyColorBtn = document.getElementById('apply-color-btn');
        const presetGradientSelect = document.getElementById('preset-gradient-select');
        const setDefaultGradientBtn = document.getElementById('set-default-gradient-btn');
        const systemThemeBtn = document.getElementById('system-theme-btn');
        const lightThemeBtn = document.getElementById('light-theme-btn');
        const darkThemeBtn = document.getElementById('dark-theme-btn');


        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            applyTheme(currentThemeMode);
            applyBackground(localStorage.getItem('userBgType') || 'preset', localStorage.getItem('userBgValue') || '默认渐变');
            renderCurrencyGridSkeleton();
            fetchRates();
            populateSettingsModal();
            populatePresetGradients();
            updateThemeButtons();
        });
        
        // --- Theme and Background Functions ---
        function applyTheme(mode) {
            currentThemeMode = mode;
            document.body.classList.remove('light-mode', 'dark-mode');
            if (mode === 'light') {
                document.body.classList.add('light-mode');
            } else if (mode === 'dark') {
                document.body.classList.add('dark-mode');
            } else { // system
                // Let CSS media query handle it
            }
            // Reapply background to ensure colors adapt to new theme
            applyBackground(localStorage.getItem('userBgType') || 'preset', localStorage.getItem('userBgValue') || '默认渐变');
            localStorage.setItem('themeMode', mode);
            updateThemeButtons();
        }

        function updateThemeButtons() {
            systemThemeBtn.classList.remove('active');
            lightThemeBtn.classList.remove('active');
            darkThemeBtn.classList.remove('active');

            if (currentThemeMode === 'system') {
                systemThemeBtn.classList.add('active');
            } else if (currentThemeMode === 'light') {
                lightThemeBtn.classList.add('active');
            } else {
                darkThemeBtn.classList.add('active');
            }
        }

        function getSystemThemePreference() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        
        function applyBackground(type, value) {
            let startColor, endColor;
            let actualTheme = currentThemeMode === 'system' ? getSystemThemePreference() : currentThemeMode;

            if (type === 'custom') {
                const h = hexToHsl(value);
                startColor = `hsl(${h.h}, ${h.s}%, ${Math.min(95, h.l + 10)}%)`;
                endColor = `hsl(${h.h}, ${h.s}%, ${Math.max(5, h.l - 10)}%)`;
            } else { // preset
                const selectedPreset = PRESET_GRADIENTS.find(g => g.name === value) || PRESET_GRADIENTS[PRESET_GRADIENTS.length - 1]; // Default to last preset
                startColor = actualTheme === 'dark' ? selectedPreset.darkStart : selectedPreset.start;
                endColor = actualTheme === 'dark' ? selectedPreset.darkEnd : selectedPreset.end;
            }
            
            document.body.style.backgroundImage = `linear-gradient(135deg, ${startColor} 0%, ${endColor} 100%)`;
            currentGradient.start = startColor;
            currentGradient.end = endColor;
            localStorage.setItem('userBgType', type);
            localStorage.setItem('userBgValue', value);
        }
        
        function hexToHsl(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) { // #RGB
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) { // #RRGGBB
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            r /= 255; g /= 255; b /= 255;

            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0; // achromatic
            } else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        }

        async function fetchRates() {
            rateInfo.textContent = '正在加载最新汇率...';
            try {
                const response = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/CNY`);
                if (!response.ok) throw new Error('网络请求失败');
                const data = await response.json();

                if (data.result === 'success') {
                    rates = data.conversion_rates;
                    rates['CNY'] = 1;
                    const lastUpdate = new Date(data.time_last_update_utc).toLocaleString();
                    rateInfo.textContent = `汇率数据更新于: ${lastUpdate}`;
                    document.querySelectorAll('.currency-input').forEach(input => input.disabled = false);
                } else {
                    rateInfo.textContent = `API错误: ${data['error-type']}`;
                }
            } catch (error) {
                rateInfo.textContent = '汇率加载失败，请检查网络或刷新页面。';
                console.error(error);
            }
        }

        function renderCurrencyGridSkeleton() {
            currencyGrid.innerHTML = '';
            const fragment = document.createDocumentFragment();
            activeCurrencies.forEach(code => {
                const card = document.createElement('div');
                card.className = 'currency-card';
                card.innerHTML = `<div class="currency-label">${code}</div><input type="number" class="currency-input" data-currency="${code}" placeholder="${ALL_CURRENCIES[code]}" disabled>`;
                fragment.appendChild(card);
            });
            currencyGrid.appendChild(fragment);
            document.querySelectorAll('.currency-input').forEach(input => {
                input.addEventListener('input', handleConversion);
            });
            // Auto-focus CNY input if present
            const cnyInput = document.querySelector('.currency-input[data-currency="CNY"]');
            if (cnyInput) {
                setTimeout(() => cnyInput.focus(), 0);
            }
        }
        
        function handleConversion(event) {
            const sourceInput = event.target;
            const sourceCurrency = sourceInput.dataset.currency;
            const sourceValue = parseFloat(sourceInput.value);
            if (Object.keys(rates).length === 0) return;
            if (isNaN(sourceValue) || sourceValue === 0) {
                clearAllInputs(sourceInput);
                if (sourceCurrency === 'CNY') convertRmbToCapital('');
                return;
            }
            const cnyBaseValue = sourceValue / rates[sourceCurrency];
            document.querySelectorAll('.currency-input').forEach(input => {
                if (input === sourceInput) return;
                const targetCurrency = input.dataset.currency;
                const targetValue = cnyBaseValue * rates[targetCurrency];
                let decimals = targetValue > 1000 ? 2 : 4; // More precision for smaller values
                input.value = targetValue.toFixed(decimals);
            });
            if (sourceCurrency === 'CNY') {
                convertRmbToCapital(sourceValue);
            } else {
                convertRmbToCapital(cnyBaseValue);
            }
        }
        
        function clearAllInputs(exceptInput = null) {
            document.querySelectorAll('.currency-input').forEach(input => {
                if (input !== exceptInput) input.value = '';
            });
            capitalResult.textContent = '';
        }
        
        function convertRmbToCapital(number) {
            let n = parseFloat(number);
            if (isNaN(n) || n === 0) {
                capitalResult.textContent = ''; return;
            }
            if (n > 999999999999.99) { // Max value for common use
                capitalResult.textContent = '错误：金额过大。'; return;
            }
            const digit = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
            const unit = [['元', '万', '亿'], ['', '拾', '佰', '仟']];
            const head = n < 0 ? '负' : '';
            n = Math.abs(n);
            let s = '';
            // Deal with fraction part
            const fraction = Math.round(n * 100 + 0.000000001) % 100; // Add small value to avoid float precision issues
            if (fraction > 0) {
                const jiao = Math.floor(fraction / 10);
                const fen = fraction % 10;
                s = (jiao === 0 ? '零' : digit[jiao] + '角') + (fen === 0 ? '' : digit[fen] + '分');
                s = s.replace(/零角/, '零'); // '零角' -> '零'
            }
            
            let integerPart = Math.floor(n);
            if (integerPart === 0) {
                s = s === '' ? '零元整' : '零元' + s;
            } else {
                let temp = '';
                for (let i = 0; i < unit[0].length && integerPart > 0; i++) {
                    let p = '';
                    for (let j = 0; j < unit[1].length && integerPart > 0; j++) {
                        p = digit[integerPart % 10] + unit[1][j] + p;
                        integerPart = Math.floor(integerPart / 10);
                    }
                    temp = p.replace(/(零.)*零$/, '').replace(/^$/, '零') + unit[0][i] + temp;
                }
                s = temp.replace(/(零.)*零元/, '元').replace(/(零.)+/g, '零') + (s === '' ? '整' : s);
            }
            
            capitalResult.textContent = head + s.replace(/^零元/, '').replace(/^元/, '').replace(/零整$/, '整');
            if (capitalResult.textContent === '') { // handle cases like 0.00
                capitalResult.textContent = '零元整';
            }
        }
        
        function loadSettings() {
            const savedCurrencies = localStorage.getItem('userCurrencies');
            activeCurrencies = savedCurrencies ? JSON.parse(savedCurrencies) : ['CNY', 'USD', 'JPY', 'HKD'];
            const savedThemeMode = localStorage.getItem('themeMode');
            if (savedThemeMode) {
                currentThemeMode = savedThemeMode;
            } else {
                currentThemeMode = 'system';
            }
        }

        function saveSettings() {
            const newSelection = Array.from(document.querySelectorAll('#currency-options input:checked')).map(input => input.value);
            if (newSelection.length < 2) {
                alert('请至少选择两种货币。'); return;
            }
            localStorage.setItem('userCurrencies', JSON.stringify(newSelection));
            activeCurrencies = newSelection;
            renderCurrencyGridSkeleton(); 
            fetchRates();
            populateSettingsModal();
            settingsModal.classList.remove('visible');
            
            localStorage.setItem('themeMode', currentThemeMode); // Save current theme mode
        }

        function populateSettingsModal() {
            currencyOptionsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            for (const code in ALL_CURRENCIES) {
                const label = document.createElement('label');
                label.className = 'currency-option';
                const isChecked = activeCurrencies.includes(code) ? 'checked' : '';
                label.innerHTML = `<input type="checkbox" value="${code}" ${isChecked}> ${code} (${ALL_CURRENCIES[code]})`;
                fragment.appendChild(label);
            }
            currencyOptionsContainer.appendChild(fragment);
        }

        function populatePresetGradients() {
            presetGradientSelect.innerHTML = '<option value="">选择一个预设...</option>';
            PRESET_GRADIENTS.forEach(gradient => {
                const option = document.createElement('option');
                option.value = gradient.name;
                option.textContent = gradient.name;
                presetGradientSelect.appendChild(option);
            });
            const savedBgValue = localStorage.getItem('userBgValue');
            if (savedBgValue) {
                presetGradientSelect.value = savedBgValue;
            }
        }

        // --- Event Listeners ---
        settingsBtn.addEventListener('click', () => settingsModal.classList.add('visible'));
        closeModalBtn.addEventListener('click', () => settingsModal.classList.remove('visible'));
        saveSettingsBtn.addEventListener('click', saveSettings);
        
        copyCapitalBtn.addEventListener('click', () => {
            const textToCopy = capitalResult.textContent;
            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = copyCapitalBtn.textContent;
                    copyCapitalBtn.textContent = '已复制！';
                    setTimeout(() => {
                        copyCapitalBtn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('复制失败: ', err);
                });
            }
        });

        applyColorBtn.addEventListener('click', () => {
            const newColor = bgColorPicker.value;
            applyBackground('custom', newColor);
        });

        setDefaultGradientBtn.addEventListener('click', () => {
            const selectedGradientName = presetGradientSelect.value;
            if (selectedGradientName) {
                applyBackground('preset', selectedGradientName);
            } else {
                alert('请选择一个预设渐变。');
            }
        });

        systemThemeBtn.addEventListener('click', () => applyTheme('system'));
        lightThemeBtn.addEventListener('click', () => applyTheme('light'));
        darkThemeBtn.addEventListener('click', () => applyTheme('dark'));

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (currentThemeMode === 'system') {
                applyBackground(localStorage.getItem('userBgType') || 'preset', localStorage.getItem('userBgValue') || '默认渐变');
            }
        });
    </script>
</body>
</html>